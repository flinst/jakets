"use strict";
const Path = require("path");
const Util = require("./Util");
const Jake = require("./Jake");
const Command_1 = require("./Command");
let RawExec = Util.CreateNodeExec("browserify", "browserify --help", "browserify/bin/cmd.js");
let Tsify = "tsify";
Tsify = Util.FindModulePath(Tsify) || Tsify;
let Collapser = "bundle-collapser/plugin.js";
Collapser = Util.FindModulePath(Collapser) || Collapser;
function Exec(inputs, output, callback, isRelease, tsargs, options, isSilent) {
    let args = inputs;
    if (tsargs !== null) {
        args += " -p [ " + Tsify + " --global " + (tsargs || "") + " ]";
    }
    if (isRelease) {
        args += "  -p [ " + Collapser + " ]";
    }
    else {
        args += " --debug";
    }
    args += " --outfile " + output;
    if (options) {
        args += " " + options;
    }
    Jake.Shell.mkdir("-p", Path.dirname(output));
    RawExec(args, callback, isSilent);
}
exports.Exec = Exec;
function BrowserifyTask(name, dependencies, output, inputs, isRelease, tsargs, options) {
    let depInfo = new Command_1.CommandInfo({
        Name: name,
        Dir: Path.resolve(Util.LocalDir),
        Output: output,
        Inputs: inputs,
        IsRelease: isRelease,
        Tsargs: tsargs,
        Options: options,
        Dependencies: dependencies
    });
    file(depInfo.DependencyFile, depInfo.AllDependencies, function () {
        Exec(inputs, output, (error, stdout, stderror) => {
            Command_1.ExtractFilesAndUpdateDependencyInfo(depInfo, error, stdout, stderror);
            this.complete();
            Jake.LogTask(this, 2);
        }, isRelease, tsargs, (options || "") + " --list", true);
    }, { async: true });
    file(output, [depInfo.DependencyFile], function () {
        Exec(inputs, output, () => {
            this.complete();
            Jake.LogTask(this, 2);
        }, isRelease, tsargs, options);
    }, { async: true });
    return output;
}
exports.BrowserifyTask = BrowserifyTask;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQnJvd3NlcmlmeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkJyb3dzZXJpZnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE1BQVksSUFBSSxXQUFNLE1BQU0sQ0FBQyxDQUFBO0FBQzdCLE1BQVksSUFBSSxXQUFNLFFBQVEsQ0FBQyxDQUFBO0FBQy9CLE1BQVksSUFBSSxXQUFNLFFBQVEsQ0FBQyxDQUFBO0FBQy9CLDBCQUFpRSxXQUFXLENBQUMsQ0FBQTtBQUU3RSxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsY0FBYyxDQUMvQixZQUFZLEVBQ1osbUJBQW1CLEVBQ25CLHVCQUF1QixDQUN4QixDQUFDO0FBRUYsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDO0FBQ3BCLEtBQUssR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssQ0FBQztBQUU1QyxJQUFJLFNBQVMsR0FBRyw0QkFBNEIsQ0FBQztBQUM3QyxTQUFTLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsSUFBSSxTQUFTLENBQUM7QUFFeEQsY0FBcUIsTUFBYyxFQUFFLE1BQWMsRUFBRSxRQUFRLEVBQUUsU0FBbUIsRUFBRSxNQUFlLEVBQUUsT0FBZ0IsRUFBRSxRQUFrQjtJQUN2SSxJQUFJLElBQUksR0FBRyxNQUFNLENBQUM7SUFDbEIsRUFBRSxDQUFDLENBQUMsTUFBTSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDcEIsSUFBSSxJQUFJLFFBQVEsR0FBRyxLQUFLLEdBQUcsWUFBWSxHQUFHLENBQUMsTUFBTSxJQUFJLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQztJQUNsRSxDQUFDO0lBQ0QsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUNkLElBQUksSUFBSSxTQUFTLEdBQUcsU0FBUyxHQUFHLElBQUksQ0FBQztJQUN2QyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixJQUFJLElBQUksVUFBVSxDQUFDO0lBQ3JCLENBQUM7SUFDRCxJQUFJLElBQUksYUFBYSxHQUFHLE1BQU0sQ0FBQztJQUMvQixFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ1osSUFBSSxJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUM7SUFDeEIsQ0FBQztJQUVELElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFFN0MsT0FBTyxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7QUFDcEMsQ0FBQztBQWxCZSxZQUFJLE9Ba0JuQixDQUFBO0FBRUQsd0JBQ0UsSUFBWSxFQUNWLFlBQXNCLEVBQ3RCLE1BQWMsRUFDZCxNQUFjLEVBQ2QsU0FBbUIsRUFDbkIsTUFBZSxFQUNmLE9BQWdCO0lBRWxCLElBQUksT0FBTyxHQUFHLElBQUkscUJBQVcsQ0FBQztRQUM1QixJQUFJLEVBQUUsSUFBSTtRQUNWLEdBQUcsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDaEMsTUFBTSxFQUFFLE1BQU07UUFDZCxNQUFNLEVBQUUsTUFBTTtRQUNkLFNBQVMsRUFBRSxTQUFTO1FBQ3BCLE1BQU0sRUFBRSxNQUFNO1FBQ2QsT0FBTyxFQUFFLE9BQU87UUFDaEIsWUFBWSxFQUFFLFlBQVk7S0FDM0IsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUUsT0FBTyxDQUFDLGVBQWUsRUFBRTtRQUNwRCxJQUFJLENBQ0YsTUFBTSxFQUNKLE1BQU0sRUFDTixDQUFDLEtBQUssRUFBRSxNQUFjLEVBQUUsUUFBUTtZQUNoQyw2Q0FBbUMsQ0FBQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQztZQUN0RSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDaEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDeEIsQ0FBQyxFQUNDLFNBQVMsRUFDVCxNQUFNLEVBQ04sQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDLEdBQUcsU0FBUyxFQUMzQixJQUFJLENBQ1AsQ0FBQztJQUNKLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBRXBCLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLEVBQUU7UUFDckMsSUFBSSxDQUNGLE1BQU0sRUFDSixNQUFNLEVBQ047WUFDQSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDaEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDeEIsQ0FBQyxFQUNDLFNBQVMsRUFDVCxNQUFNLEVBQ04sT0FBTyxDQUNWLENBQUM7SUFDSixDQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUVwQixNQUFNLENBQUMsTUFBTSxDQUFDO0FBQ2hCLENBQUM7QUFuRGUsc0JBQWMsaUJBbUQ3QixDQUFBIn0=